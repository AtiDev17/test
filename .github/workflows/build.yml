name: Build Qt6 for Windows 7

on:
  workflow_dispatch:
    inputs:
      qt_version:
        description: 'Qt Version to build'
        required: true
        default: '6.10.ÃŸ'

jobs:
  build:
    name: Build Qt ${{ inputs.qt_version }}
    runs-on: windows-2022
    timeout-minutes: 360
    
    steps:
      - name: Checkout My Repo
        uses: actions/checkout@v4

      - name: Checkout Patch Repo
        uses: actions/checkout@v4
        with:
          repository: ANightly/qt6windows7
          path: patch_repo
          ref: 6.10.0

      - name: Install Perl Dependencies
        run: cpanm Path::Tiny IPC::Cmd

      - name: Install wget
        run: choco install wget --no-progress

      - name: Download Official Qt Source
        shell: bash
        run: |
          QT_VER="${{ inputs.qt_version }}"
          echo "Downloading Qt $QT_VER..."
          wget https://download.qt.io/official_releases/qt/${QT_VER%.*}/$QT_VER/single/qt-everywhere-src-$QT_VER.tar.xz
          
          echo "Extracting Qt Source..."
          7z x qt-everywhere-src-$QT_VER.tar.xz
          7z x qt-everywhere-src-$QT_VER.tar
          
          mv qt-everywhere-src-$QT_VER/* .
          rm -rf qt-everywhere-src-$QT_VER

      - name: Apply Windows 7 Backports
        shell: bash
        run: |
          echo "Copying patches..."
          cp -r patch_repo/qtbase/src/* qtbase/src/

      - name: Patch Build Script
        shell: bash
        run: |
          # 1. Fix Visual Studio Path
          sed -i 's/Community/Enterprise/g' compile_win.pl
          
          # 2. Disable extracting cmake.7z
          sed -i 's/7z x cmake.7z/REM 7z x cmake.7z/g' compile_win.pl

          # 3. CRITICAL: Remove 'system("pause")'
          sed -i 's/system ("pause");/# system ("pause");/g' compile_win.pl

          # 4. CRITICAL: Prevent deleting build dir (for cache)
          sed -i 's/rmdir $build_dir/# rmdir $build_dir/g' compile_win.pl

          # 5. NEW: ENABLE SVG SUPPORT
          # The script specifically skips 'qtsvg'. We remove that skip here.
          sed -i 's/\s*qtsvg\s*/ /g' compile_win.pl

          sed -i 's/die "Error: build dir/# die "Error: build dir/g' compile_win.pl

      - name: Setup Build Tools
        shell: powershell
        run: |
          Get-Command cmake | Copy-Item -Destination _tools\cmake.exe
          Get-Command ninja | Copy-Item -Destination _tools\ninja.exe

      - name: Restore Qt Build Cache
        id: cache-qt-restore
        uses: actions/cache/restore@v4
        with:
          path: _qt6-build-amd64
          key: qt6-build-${{ runner.os }}-${{ inputs.qt_version }}-${{ hashFiles('compile_win.pl') }}
          restore-keys: |
            qt6-build-${{ runner.os }}-${{ inputs.qt_version }}-

      - name: Run Build Script
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          perl compile_win.pl amd64 %CD%\qt6-install

      - name: Package DLLs and Plugins
        shell: cmd
        run: |
          mkdir artifacts
          mkdir artifacts\plugins
          
          echo "Copying Main DLLs..."
          if exist qt6-install\bin\Qt6Core.dll (
              copy qt6-install\bin\*.dll artifacts\
          ) else (
              echo "Build failed!"
              exit 1
          )

          echo "Copying Plugins (platforms, imageformats, styles, etc)..."
          xcopy qt6-install\plugins artifacts\plugins /E /I /Y

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: qt6-win7-full
          path: artifacts/

      - name: Save Qt Build Cache
        id: cache-qt-save
        uses: actions/cache/save@v4
        if: always() 
        with:
          path: _qt6-build-amd64
          key: qt6-build-${{ runner.os }}-${{ inputs.qt_version }}-${{ hashFiles('compile_win.pl') }}
