name: Build Qt6 for Windows 7

on:
  workflow_dispatch:
    inputs:
      qt_version:
        description: 'Qt Version to build'
        required: true
        default: '6.9.3'

jobs:
  build:
    name: Build Qt ${{ inputs.qt_version }}
    runs-on: windows-2022
    timeout-minutes: 360
    
    steps:
      # 1. Checkout YOUR code (gets compile_win.pl and the _tools folder)
      - name: Checkout My Repo
        uses: actions/checkout@v4

      # 2. Checkout the PATCHES (puts them in a subfolder)
      - name: Checkout Patch Repo
        uses: actions/checkout@v4
        with:
          repository: ANightly/qt6windows7
          path: patch_repo
          ref: master

      - name: Install Perl Dependencies
        run: cpanm Path::Tiny IPC::Cmd

      - name: Install wget
        run: choco install wget --no-progress

      - name: Download Official Qt Source
        shell: bash
        run: |
          QT_VER="${{ inputs.qt_version }}"
          echo "Downloading Qt $QT_VER..."
          wget https://download.qt.io/official_releases/qt/${QT_VER%.*}/$QT_VER/single/qt-everywhere-src-$QT_VER.tar.xz
          
          echo "Extracting Qt Source..."
          7z x qt-everywhere-src-$QT_VER.tar.xz
          7z x qt-everywhere-src-$QT_VER.tar
          
          # CRITICAL FIX: Move files to root so compile_win.pl can find 'qtbase'
          # The tar extracts to a folder like 'qt-everywhere-src-6.9.3'
          # We move the CONTENTS of that folder to the current directory (.)
          mv qt-everywhere-src-$QT_VER/* .
          rm -rf qt-everywhere-src-$QT_VER

      - name: Apply Windows 7 Backports
        shell: bash
        run: |
          echo "Copying patches..."
          # Now that qtbase is in the root, we copy directly there
          cp -r patch_repo/qtbase/src/* qtbase/src/

      - name: Patch Build Script
        shell: bash
        run: |
          # 1. Fix Visual Studio Path (Community -> Enterprise)
          sed -i 's/Community/Enterprise/g' compile_win.pl
          
          # 2. Disable extracting cmake.7z (We use system cmake)
          sed -i 's/7z x cmake.7z/# 7z x cmake.7z/g' compile_win.pl

          # 3. CRITICAL: Remove 'system("pause")' or the build will HANG forever
          sed -i 's/system ("pause");/# system ("pause");/g' compile_win.pl

          # 4. CRITICAL: Prevent script from deleting the build dir so we can CACHE it
          sed -i 's/rmdir $build_dir/# rmdir $build_dir/g' compile_win.pl

      - name: Setup Build Tools
        shell: powershell
        run: |
          # Copy system tools to _tools so the script finds them
          Get-Command cmake | Copy-Item -Destination _tools\cmake.exe
          Get-Command ninja | Copy-Item -Destination _tools\ninja.exe
          Write-Host "Tools populated successfully."

      - name: Cache Qt Build
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: _qt6-build-amd64
          key: qt6-build-${{ runner.os }}-${{ inputs.qt_version }}-${{ hashFiles('compile_win.pl') }}
          restore-keys: |
            qt6-build-${{ runner.os }}-${{ inputs.qt_version }}-

      - name: Run Build Script
        shell: cmd
        run: |
          :: Initialize VS Environment
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          
          :: Run the build
          :: We use %CD%\qt6-install to force an absolute path.
          :: This ensures files land in D:\a\test\test\qt6-install
          perl compile_win.pl amd64 %CD%\qt6-install

      - name: Package DLLs
        shell: cmd
        run: |
          mkdir artifacts
          
          echo "Looking for compiled DLLs in root qt6-install..."
          
          if exist qt6-install\bin\Qt6Core.dll (
              echo "Found in qt6-install\bin!"
              copy qt6-install\bin\*.dll artifacts\
          ) else (
              echo "Build failed or files missing."
              exit 1
          )

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: qt6-win7-dlls
          path: artifacts/
